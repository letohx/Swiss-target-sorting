<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Швейцарская сортировка задач</title>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
:root{--bg:#f6f7fb;--card:#ffffff;--muted:#666;--accent:#2b8aee;--danger:#ff4d4f;--success:#4caf50;--shadow:0 6px 18px rgba(16,24,40,0.06);}
[data-theme="dark"]{--bg:#0f1113;--card:#161718;--muted:#bfc3c8;--accent:#4aa3ff;--danger:#ff6b6b;--success:#66bb6a;--shadow:0 6px 18px rgba(0,0,0,0.6);}
html,body{height:100%;margin:0;}
body{font-family:system-ui,Arial,"Segoe UI",Roboto;max-width:980px;margin:20px auto;padding:16px;background:var(--bg);color:#222;}
h1{margin:0 0 8px;font-size:20px;}
.small{font-size:13px;color:var(--muted);margin-bottom:12px;}
.header{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;}
button.icon{width:44px;height:44px;border-radius:8px;border:none;background:var(--card);box-shadow:var(--shadow);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
button.primary{background:var(--accent);color:white;}
#themeBtn,#resetRatingBtn{width:44px;height:44px;border-radius:50%;background:var(--card);box-shadow:var(--shadow);}
#exitBtn{display:none;}
.input-group{flex:1;display:flex;gap:8px;min-width:280px;align-items:center;}
textarea#itemInput{flex:1;min-height:44px;max-height:120px;padding:10px;font-size:15px;border-radius:8px;border:1px solid #dfe3e8;background:var(--card);color:inherit;resize:vertical;}
#addBtn{width:48px;height:48px;border-radius:50%;background:var(--accent);color:#fff;font-size:22px;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow);flex-shrink:0;}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:var(--shadow);margin-top:12px;}
.flex{display:flex;gap:12px;align-items:center;}
#listsPanel{background:var(--card);border-radius:12px;padding:8px;box-shadow:var(--shadow);margin-bottom:12px;overflow-x:auto;white-space:nowrap;display:flex;align-items:center;position:relative;-webkit-overflow-scrolling:touch;}
.list-tab{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;background:transparent;color:var(--muted);font-weight:500;transition:all .2s;min-width:120px;justify-content:center;position:relative;touch-action:pan-x;}
.list-tab.active{background:var(--accent);color:white;font-weight:600;}
.list-tab.trash{color:var(--danger);}
.list-tab.trash.active{background:var(--danger);color:white;}
.list-tab .badge{background:rgba(255,255,255,.3);color:white;font-size:11px;padding:2px 6px;border-radius:8px;}
.list-tab .delete-list{display:none;position:absolute;right:4px;top:4px;background:var(--danger);color:white;width:20px;height:20px;border-radius:50%;font-size:12px;align-items:center;justify-content:center;cursor:pointer;z-index:10;touch-action:manipulation;}
.list-tab.delete-mode .delete-list{display:flex;}
#addListBtn{width:44px;height:44px;border-radius:50%;background:var(--card);box-shadow:var(--shadow);border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;margin-left:8px;flex-shrink:0;}
ul#list{list-style:none;margin:0;padding:0;margin-top:8px;}
li.item{position:relative;display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;margin:5px 0;background:var(--card);border:1px solid rgba(0,0,0,.04);overflow:hidden;touch-action:pan-y;user-select:none;}
.handle{cursor:grab;color:#9aa4b2;font-size:18px;padding:3px 10px;}
.name{font-size:15px;flex:1;}
.delete-overlay,.restore-overlay{position:absolute;left:0;top:0;bottom:0;width:100%;color:#fff;display:flex;align-items:center;padding:0 16px;font-weight:700;opacity:0;pointer-events:none;transition:opacity .15s;border-radius:8px;}
.delete-overlay{background:var(--danger);justify-content:flex-end;}
.restore-overlay{background:var(--success);justify-content:flex-start;}
.removing{transition:transform .3s ease,opacity .3s ease;transform:translateY(-40px) scale(.95);opacity:0;}
.choices{display:flex;gap:12px;margin-top:10px;}
.item-btn{flex:1;padding:12px;border-radius:8px;border:1px solid #d0d6dc;background:#fafafa;font-size:16px;cursor:pointer;}
#bracket{display:flex;gap:16px;align-items:flex-start;overflow:auto;padding:8px;margin-top:12px;}
.bracket-col{min-width:180px;background:#fafafa;border-radius:8px;padding:8px;border:1px solid #eee;}
.pair{padding:8px;margin-bottom:8px;border-radius:6px;background:var(--card);border:1px solid #eaecef;}
.winner{font-weight:700;color:#1a7f1a;}
.loser{color:#777;text-decoration:line-through;}
.bye{color:#444;font-style:italic;}
.action-buttons{display: flex;flex-direction: row;
justify-content: space-around;}
@media(max-width:600px){.header{flex-direction:column;align-items:stretch;}.list-tab{min-width:100px;font-size:14px;padding:10px 12px;}}
</style>
</head>
<body data-theme="light">
<h1>Швейцарская сортировка задач</h1>

<div id="listsPanel">
  <div id="listsContainer"></div>
  <button id="addListBtn" title="Новый список"><i data-lucide="plus"></i></button>
</div>

<div class="header">
  <div class="action-buttons">
    <button id="startBtn" class="icon primary" title="Начать сортировку"><i data-lucide="shuffle"></i></button>
    <button id="exitBtn"><i data-lucide="x"></i></button>
    <button id="clearBtn" class="icon" title="Очистить"><i data-lucide="trash-2"></i></button>
    <button id="resetRatingBtn" class="icon" title="Сбросить рейтинги"><i data-lucide="rotate-cw"></i></button>
    <button id="themeBtn"><i data-lucide="moon"></i></button>
  </div>
  <div class="input-group">
    <textarea id="itemInput" placeholder="Добавить пункт или вставить список"></textarea>
    <button id="addBtn"><i data-lucide="plus"></i></button>
  </div>
</div>

<div id="sortCard" class="card" style="display:none;">
  <div class="round-title" id="roundTitle">Раунд</div>
  <div class="choices">
    <button id="leftBtn" class="item-btn"></button>
    <button id="rightBtn" class="item-btn"></button>
  </div>
  <div class="meta">Пара <span id="pairNum">0</span> из <span id="pairMax">0</span></div>
  <div class="flex" style="margin-bottom:12px;">
  <div class="meta">Раундов: <strong id="roundsNum">0</strong> • Текущий: <strong id="currentRound">0</strong></div>
</div>
</div>


<div class="card"><ul id="list"></ul></div>

<div id="ratingDisplay" class="card" style="display:none;margin-top:12px;"></div>
<div id="bracket" class="card" style="display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();

  const K_FACTOR = 32;
  let listNames = [], currentListName = '', items = {}, rating = {}, trash = [];
  let rounds = [], roundsResults = [], curRound = 0, curPair = 0, running = false;
  let sortable = null;
  let currentDeleteModeTab = null;

  const listsContainer = document.getElementById('listsContainer');
  const listEl = document.getElementById('list');
  const itemInput = document.getElementById('itemInput');
  const addBtn = document.getElementById('addBtn');
  const addListBtn = document.getElementById('addListBtn');
  const clearBtn = document.getElementById('clearBtn');
  const startBtn = document.getElementById('startBtn');
  const resetRatingBtn = document.getElementById('resetRatingBtn');
  const themeBtn = document.getElementById('themeBtn');
  const exitBtn = document.getElementById('exitBtn');
  const sortCard = document.getElementById('sortCard');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const roundTitle = document.getElementById('roundTitle');
  const pairNum = document.getElementById('pairNum');
  const pairMax = document.getElementById('pairMax');
  const ratingDisplay = document.getElementById('ratingDisplay');
  const bracketEl = document.getElementById('bracket');
  const roundsNumEl = document.getElementById('roundsNum');
  const currentRoundEl = document.getElementById('currentRound');

  function key(l,i){return `${l}|${i}`;}
  function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

  function load(){
    try{
      listNames=JSON.parse(localStorage.getItem('swiss_lists_v18')||'[]');
      items=JSON.parse(localStorage.getItem('swiss_items_v18')||'{}');
      rating=JSON.parse(localStorage.getItem('swiss_rating_v18')||'{}');
      trash=JSON.parse(localStorage.getItem('swiss_trash_v18')||'[]');
      currentListName=localStorage.getItem('swiss_cur_v18')||'';
      const th=localStorage.getItem('swiss_theme')||'light';
      document.documentElement.setAttribute('data-theme',th);
      themeBtn.querySelector('i').setAttribute('data-lucide',th==='dark'?'sun':'moon');
    }catch(e){console.warn(e);}
    if(listNames.length===0){listNames=['Основной'];items['Основной']=[];}
    if(!currentListName || !listNames.includes(currentListName)) currentListName=listNames[0];
  }
  function save(){
    localStorage.setItem('swiss_lists_v18',JSON.stringify(listNames));
    localStorage.setItem('swiss_items_v18',JSON.stringify(items));
    localStorage.setItem('swiss_rating_v18',JSON.stringify(rating));
    localStorage.setItem('swiss_trash_v18',JSON.stringify(trash));
    localStorage.setItem('swiss_cur_v18',currentListName);
  }

  function stopSortingIfRunning(){
    if(!running) return true;
    if(confirm('Сортировка активна. Прервать?')){
      running=false; resetUI(); return true;
    }
    return false;
  }

  function hideDeleteButton(){
    if(currentDeleteModeTab){
      currentDeleteModeTab.classList.remove('delete-mode');
      currentDeleteModeTab = null;
    }
  }

  document.addEventListener('click', e => {
    if (!e.target.closest('.list-tab') && !e.target.closest('#addListBtn')) hideDeleteButton();
  });

  function canDeleteList() {
    return listNames.length > 1;
  }

  function renderTabs(){
    listsContainer.innerHTML = '';
    listNames.forEach(n => {
      const tab = document.createElement('div');
      tab.className = 'list-tab' + (currentListName === n ? ' active' : '');
      const canDelete = canDeleteList();
      tab.innerHTML = `
        <span class="tab-name">${esc(n)}</span>
        <span class="badge">${(items[n]||[]).length}</span>
        ${canDelete ? `<div class="delete-list">×</div>` : ''}
      `;

      let touchStartTime = 0, isScrolling = false, longPressTriggered = false, longPressTimer;

      const handleTouchStart = e => {
        touchStartTime = Date.now();
        isScrolling = false;
        longPressTriggered = false;
        if(canDelete){
          longPressTimer = setTimeout(() => {
            if(!isScrolling && Date.now() - touchStartTime > 580){
              hideDeleteButton();
              tab.classList.add('delete-mode');
              currentDeleteModeTab = tab;
              longPressTriggered = true;
            }
          }, 600);
        }
      };

      const handleTouchMove = e => {
        const dx = Math.abs(e.touches[0].clientX - e.touches[0].clientX);
        const dy = Math.abs(e.touches[0].clientY - e.touches[0].clientY);
        if(dx > 10 || dy > 10){
          isScrolling = true;
          clearTimeout(longPressTimer);
        }
      };

      const handleTouchEnd = e => {
        clearTimeout(longPressTimer);
        if(longPressTriggered){ e.preventDefault(); return; }
        if(isScrolling) return;
        if(e.target.classList.contains('delete-list')) return;
        if(tab.classList.contains('delete-mode')){ hideDeleteButton(); return; }
        if(currentDeleteModeTab && currentDeleteModeTab !== tab) currentDeleteModeTab.classList.remove('delete-mode');
        if(stopSortingIfRunning()) switchList(n);
      };

      tab.addEventListener('touchstart', handleTouchStart, {passive:true});
      tab.addEventListener('touchmove', handleTouchMove, {passive:true});
      tab.addEventListener('touchend', handleTouchEnd, {passive:false});

      tab.addEventListener('contextmenu', e => e.preventDefault());
      tab.addEventListener('mousedown', e => {
        if(e.button !== 0 || !canDelete) return;
        longPressTimer = setTimeout(() => {
          hideDeleteButton();
          tab.classList.add('delete-mode');
          currentDeleteModeTab = tab;
        }, 600);
      });
      tab.addEventListener('mouseup', () => clearTimeout(longPressTimer));
      tab.addEventListener('mouseleave', () => clearTimeout(longPressTimer));

      tab.addEventListener('click', e => {
        if(e.detail === 0) return;
        if(e.target.classList.contains('delete-list')) return;
        if(tab.classList.contains('delete-mode')){ hideDeleteButton(); return; }
        if(currentDeleteModeTab && currentDeleteModeTab !== tab) currentDeleteModeTab.classList.remove('delete-mode');
        if(stopSortingIfRunning()) switchList(n);
      });

      let tapCount = 0;
      tab.addEventListener('click', e => {
        if(e.target.classList.contains('delete-list')) return;
        tapCount++;
        if(tapCount === 2){
          hideDeleteButton();
          renameList(n);
          tapCount = 0;
        } else {
          setTimeout(() => tapCount = 0, 350);
        }
      });

      if(canDelete){
        tab.querySelector('.delete-list').addEventListener('click', e => {
          e.stopPropagation();
          hideDeleteButton();
          if(!stopSortingIfRunning()) return;
          if(confirm(`Удалить список «${n}» и все его задачи?`)){
            delete items[n];
            Object.keys(rating).forEach(k => { if(k.startsWith(n+'|')) delete rating[k]; });
            listNames = listNames.filter(x => x !== n);
            if(currentListName === n) switchList(listNames[0]);
            save(); renderTabs(); renderList(); updateDisplays();
          }
        });
      }

      listsContainer.appendChild(tab);
    });

    const trashTab = document.createElement('div');
    trashTab.className = 'list-tab trash' + (currentListName === 'trash' ? ' active' : '');
    trashTab.innerHTML = `<i data-lucide="trash-2"></i> Корзина <span class="badge">${trash.length}</span>`;
    trashTab.addEventListener('click', () => { hideDeleteButton(); if(stopSortingIfRunning()) switchList('trash'); });
    listsContainer.appendChild(trashTab);

    lucide.createIcons();
  }

  function renameList(oldName){
    if(!stopSortingIfRunning()) return;
    const neu = prompt('Новое название списка', oldName);
    if(!neu || neu.trim() === oldName) return;
    const newName = neu.trim();
    if(!newName){ alert('Имя не может быть пустым'); return; }
    if(listNames.includes(newName)){ alert('Список с таким именем уже существует'); return; }

    const idx = listNames.indexOf(oldName);
    listNames[idx] = newName;
    items[newName] = items[oldName]; delete items[oldName];
    Object.keys(rating).forEach(k => {
      if(k.startsWith(oldName+'|')){
        const item = k.slice(oldName.length + 1);
        rating[newName+'|'+item] = rating[k];
        delete rating[k];
      }
    });
    if(currentListName === oldName) currentListName = newName;
    save(); renderTabs(); renderList(); updateDisplays();
  }

  function switchList(n){
    if(currentListName === n) return;
    currentListName = n;
    save(); renderTabs(); renderList(); updateDisplays();
  }

  function renderList(){
    listEl.innerHTML = '';
    if(sortable){ sortable.destroy(); sortable=null; }
    const isTrash = currentListName === 'trash';
    const data = isTrash ? trash.map((t,i)=>({...t,idx:i})) : (items[currentListName]||[]).map(n=>({name:n}));

    data.forEach(o => {
      const li = document.createElement('li'); li.className='item';
      if(isTrash){
        li.dataset.idx = o.idx;
        li.innerHTML = `<div class="name" style="flex:1;">${esc(o.name)}</div><div style="color:var(--muted);font-size:12px;">из «${esc(o.fromList)}»</div><div class="restore-overlay"><i data-lucide="rotate-cw"></i> Восстановить</div><div class="delete-overlay"><i data-lucide="trash-2"></i> Удалить навсегда</div>`;
        addTrashSwipe(li);
      } else {
        li.dataset.name = o.name;
        const r = rating[key(currentListName,o.name)] || 50;
        li.innerHTML = `
          <div class="name">${esc(o.name)}</div>
          <div style="margin-left:8px;color:var(--muted);font-size:13px;">${Math.round(r)}</div>
          <div class="handle">≡</div>
          <div class="delete-overlay"><i data-lucide="trash-2"></i></div>
          <div class="delete-overlay" style="background:#2b8aee;justify-content:flex-start;">В топ</div>
        `;
        addItemTouchEdit(li);
        addItemSwipe(li);
      }
      listEl.appendChild(li);
    });

    if(!isTrash){
      sortable = new Sortable(listEl, {handle:'.handle', animation:150, onEnd:()=>{items[currentListName]=Array.from(listEl.children).map(li=>li.dataset.name);save();}});
    }
    lucide.createIcons();
  }

  // === Редактирование только при чётком тапе ===
  function addItemTouchEdit(li){
    const nameEl = li.querySelector('.name');
    let startX = 0, startY = 0, startTime = 0;
    let moved = false;
    const threshold = 8;

    const handleStart = e => {
      startX = e.touches ? e.touches[0].clientX : e.clientX;
      startY = e.touches ? e.touches[0].clientY : e.clientY;
      startTime = Date.now();
      moved = false;
    };

    const handleMove = e => {
      if(!startTime) return;
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      const y = e.touches ? e.touches[0].clientY : e.clientY;
      if(Math.abs(x - startX) > threshold || Math.abs(y - startY) > threshold){
        moved = true;
      }
    };

    const handleEnd = e => {
      if(!startTime) return;
      const duration = Date.now() - startTime;
      const x = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
      const y = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
      const dx = Math.abs(x - startX);
      const dy = Math.abs(y - startY);

      if(!moved && duration < 500 && dx < threshold && dy < threshold){
        if(stopSortingIfRunning()){
          e.preventDefault();
          editItem(li);
        }
      }
      startTime = 0;
    };

    nameEl.addEventListener('touchstart', handleStart, {passive:true});
    nameEl.addEventListener('mousedown', handleStart);

    nameEl.addEventListener('touchmove', handleMove, {passive:true});
    nameEl.addEventListener('mousemove', handleMove);

    nameEl.addEventListener('touchend', handleEnd);
    nameEl.addEventListener('mouseup', handleEnd);
    nameEl.addEventListener('touchcancel', handleEnd);
  }

  function editItem(li){
    const old = li.dataset.name;
    const neu = prompt('Редактировать', old);
    if(!neu || neu.trim() === old) return;
    const n = neu.trim();
    if(items[currentListName].includes(n)){ alert('Уже есть'); return; }
    const i = items[currentListName].indexOf(old);
    items[currentListName][i] = n;
    if(rating[key(currentListName,old)] !== undefined){
      rating[key(currentListName,n)] = rating[key(currentListName,old)];
      delete rating[key(currentListName,old)];
    }
    save(); renderList();
  }

  function addItemSwipe(li){
    let sx=0,sy=0,moved=false,swiping=false;

    const start = e => {
      if(e.target.closest('.handle')) return;
      swiping = true; sx = e.touches[0].clientX; sy = e.touches[0].clientY;
      li.style.transition = 'none'; moved = false;
    };

    const move = e => {
      if(!swiping) return;
      const dx = e.touches[0].clientX - sx;
      const dy = e.touches[0].clientY - sy;
      if(!moved && Math.abs(dy) > 10 && Math.abs(dy) > Math.abs(dx)){
        swiping = false; li.style.transition = ''; return;
      }
      if(Math.abs(dx) > 8){
        moved = true;
        li.style.transform = `translateX(${dx}px)`;
        li.children[3].style.opacity = dx < 0 ? Math.min(Math.abs(dx)/80,1) : 0;
        li.children[4].style.opacity = dx > 0 ? Math.min(dx/80,1) : 0;
      }
    };

    const end = () => {
      if(!swiping) return;
      const dx = li.style.transform ? parseFloat(li.style.transform.match(/-?\d+\.?\d*/g)[0] || 0) : 0;
      li.style.transition = 'transform .2s ease'; li.style.transform = '';
      li.children[3].style.opacity = li.children[4].style.opacity = 0;
      if(moved && dx < -80) moveToTrash(li);
      else if(moved && dx > 80) moveToTop(li);
      swiping = false;
    };

    li.addEventListener('touchstart', start, {passive:true});
    li.addEventListener('touchmove', move, {passive:true});
    li.addEventListener('touchend', end);
  }

  function addTrashSwipe(li){
    let sx=0,sy=0,moved=false,swiping=false;
    const restore = li.querySelector('.restore-overlay'), del = li.querySelector('.delete-overlay');

    li.addEventListener('touchstart', e=>{swiping=true;sx=e.touches[0].clientX;sy=e.touches[0].clientY;li.style.transition='none';moved=false;}, {passive:true});
    li.addEventListener('touchmove', e=>{
      if(!swiping) return;
      const dx=e.touches[0].clientX-sx, dy=e.touches[0].clientY-sy;
      if(!moved && Math.abs(dy)>10 && Math.abs(dy)>Math.abs(dx)){swiping=false;li.style.transition='';return;}
      if(Math.abs(dx)>8){moved=true;li.style.transform=`translateX(${dx}px)`;restore.style.opacity=dx>0?Math.min(dx/80,1):0;del.style.opacity=dx<0?Math.min(Math.abs(dx)/80,1):0;}
    }, {passive:true});
    li.addEventListener('touchend', ()=>{
      if(!swiping) return;
      const dx=li.style.transform?parseFloat(li.style.transform.match(/-?\d+\.?\d*/g)[0] || 0):0;
      li.style.transition='transform .2s ease'; li.style.transform=''; restore.style.opacity=del.style.opacity=0;
      if(moved&&dx>80) restoreFromTrash(li);
      else if(moved&&dx<-80) deleteForever(li);
      swiping=false;
    });
  }

  function moveToTrash(li){const n=li.dataset.name;li.classList.add('removing');li.ontransitionend=()=>{items[currentListName]=items[currentListName].filter(x=>x!==n);delete rating[key(currentListName,n)];trash.push({name:n,fromList:currentListName});save();renderList();renderTabs();};}
  function moveToTop(li){const n=li.dataset.name;if(items[currentListName][0]===n)return;items[currentListName]=items[currentListName].filter(x=>x!==n);items[currentListName].unshift(n);save();renderList();}
  function restoreFromTrash(li){const i=+li.dataset.idx;const it=trash[i];li.classList.add('removing');li.ontransitionend=()=>{trash.splice(i,1);if(!items[it.fromList])items[it.fromList]=[];items[it.fromList].push(it.name);save();renderList();renderTabs();};}
  function deleteForever(li){const i=+li.dataset.idx;li.classList.add('removing');li.ontransitionend=()=>{trash.splice(i,1);save();renderList();renderTabs();};}

  function addItems(){
    if(currentListName==='trash' || !stopSortingIfRunning()) return;
    const lines=itemInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
    lines.forEach(l=>{if(!items[currentListName].includes(l)){items[currentListName].push(l);rating[key(currentListName,l)]=50;}});
    if(lines.length){save();renderList();renderTabs();}
    itemInput.value=''; addBtn.style.display='none';
  }
  itemInput.addEventListener('input',()=>{addBtn.style.display=itemInput.value.trim()?'flex':'none';});
  itemInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();addItems();}});
  addBtn.onclick=addItems;

  addListBtn.onclick=()=>{if(!stopSortingIfRunning())return;const n=prompt('Название списка');if(!n?.trim())return;const name=n.trim();if(listNames.includes(name)){alert('Уже есть');return;}listNames.push(name);items[name]=[];save();switchList(name);};

  clearBtn.onclick=()=>{if(!stopSortingIfRunning())return;if(currentListName==='trash'){if(confirm('Очистить корзину навсегда?')){trash=[];save();renderList();renderTabs();}}else if(confirm('Очистить список?')){items[currentListName]=[];Object.keys(rating).forEach(k=>{if(k.startsWith(currentListName+'|'))delete rating[k];});save();renderList();renderTabs();}};

  resetRatingBtn.onclick=()=>{if(currentListName==='trash')return;if(!confirm('Сбросить рейтинги до 50?'))return;(items[currentListName]||[]).forEach(n=>rating[key(currentListName,n)]=50);save();renderList();if(running){prepareRounds();curRound=curPair=0;runRounds();}else updateDisplays();};

  themeBtn.onclick=()=>{
    const cur=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
    document.documentElement.setAttribute('data-theme',cur);
    localStorage.setItem('swiss_theme',cur);
    themeBtn.querySelector('i').setAttribute('data-lucide',cur==='dark'?'sun':'moon');
    lucide.createIcons();
  };

  function prepareRounds(){
    const arr=items[currentListName]||[];
    arr.forEach(n=>{if(rating[key(currentListName,n)]===undefined)rating[key(currentListName,n)]=50;});
    const needed=Math.ceil(Math.log2(Math.max(2,arr.length)));
    roundsNumEl.textContent=needed; rounds=[]; roundsResults=[];
    for(let r=0;r<needed;r++){
      const order=[...arr].sort((a,b)=>(rating[key(currentListName,b)]-rating[key(currentListName,a)])+(Math.random()-0.5)*1e-3);
      const pairs=[];
      for(let i=0;i<order.length;i+=2) pairs.push(i+1<order.length?[order[i],order[i+1]]:[order[i],null]);
      rounds.push(pairs); roundsResults.push(new Array(pairs.length).fill(null));
    }
  }

  async function runRounds(){
    sortCard.style.display='block'; ratingDisplay.style.display='block'; bracketEl.style.display='block'; exitBtn.style.display='flex';
    while(running && curRound<rounds.length){
      currentRoundEl.textContent=curRound+1; pairMax.textContent=rounds[curRound].length; curPair=0;
      renderBracket(); updateDisplays();
      while(running && curPair<rounds[curRound].length){
        pairNum.textContent=curPair+1; roundTitle.textContent=`Раунд ${curRound+1} — пара ${curPair+1}`;
        const [a,b]=rounds[curRound][curPair];
        if(!b){rating[key(currentListName,a)]+=8; roundsResults[curRound][curPair]=a; curPair++; updateDisplays(); await sleep(150); continue;}
        leftBtn.textContent=a; rightBtn.textContent=b;
        await new Promise(res=>{
          const clean=()=>{leftBtn.onclick=rightBtn.onclick=null;};
          leftBtn.onclick=()=>{elo(a,b);roundsResults[curRound][curPair]=a;clean();res();};
          rightBtn.onclick=()=>{elo(b,a);roundsResults[curRound][curPair]=b;clean();res();};
        });
        curPair++; updateDisplays();
      }
      curRound++;
    }
    if(running) finalize(); else exitBtn.style.display='none';
  }

  function elo(w,l){
    const Rw=rating[key(currentListName,w)]||50, Rl=rating[key(currentListName,l)]||50;
    const Ew=1/(1+Math.pow(10,(Rl-Rw)/400));
    rating[key(currentListName,w)]=Rw+K_FACTOR*(1-Ew);
    rating[key(currentListName,l)]=Rl+K_FACTOR*(0-(1-Ew));
    if(rating[key(currentListName,l)]<1) rating[key(currentListName,l)]=1;
    save();
  }

  function renderBracket(){
    bracketEl.innerHTML='';
    for(let r=0;r<rounds.length;r++){
      const col=document.createElement('div'); col.className='bracket-col'; col.innerHTML=`<strong>Раунд ${r+1}</strong>`;
      rounds[r].forEach((p,i)=>{
        const [a,b]=p; const win=roundsResults[r][i];
        const div=document.createElement('div'); div.className='pair';
        if(!b) div.innerHTML=`<div class="bye">${esc(a)} — бай</div>`;
        else div.innerHTML=`<div class="${win===a?'winner':win?'loser':''}">${esc(a)}</div><div style="margin-top:6px;" class="${win===b?'winner':win?'loser':''}">${esc(b)}</div>`;
        col.appendChild(div);
      });
      bracketEl.appendChild(col);
    }
  }

  function updateDisplays(){
    if(currentListName==='trash'){ratingDisplay.innerHTML='';return;}
    const arr=items[currentListName]||[];
    const sorted=[...arr].sort((a,b)=>(rating[key(currentListName,b)]||50)-(rating[key(currentListName,a)]||50));
    if(!sorted.length){ratingDisplay.innerHTML='';return;}
    const vals=sorted.map(n=>rating[key(currentListName,n)]||50);
    const min=Math.min(...vals), max=Math.max(...vals), range=max-min||1;
    let html='<h3>Приоритет задач</h3><ol>';
    sorted.forEach(n=>{
      const v=rating[key(currentListName,n)]||50;
      const p=Math.round((v-min)/range*100);
      const stars='★★★★★'.substring(0,Math.round(p/20))+'☆☆☆☆☆'.substring(0,5-Math.round(p/20));
      html+=`<li style="color:${p>=80?'#d32f2f':p>=60?'#f57c00':p>=40?'#388e3c':'#666'};font-weight:500;"><strong>${esc(n)}</strong> — ${p}% ${stars}</li>`;
    });
    html+='</ol>'; ratingDisplay.innerHTML=html;
  }

  function finalize(){
    running=false; startBtn.disabled=false; sortCard.style.display='none';
    roundsNumEl.textContent='0'; currentRoundEl.textContent='0';
    items[currentListName].sort((a,b)=>(rating[key(currentListName,b)]||50)-(rating[key(currentListName,a)]||50));
    save(); renderList(); renderBracket(); ratingDisplay.style.display='block'; bracketEl.style.display='block'; exitBtn.style.display='none';
    alert('Сортировка завершена!');
  }

  function resetUI(){
    running=false; startBtn.disabled=false;
    sortCard.style.display='none'; ratingDisplay.style.display='none'; bracketEl.style.display='none';
    rounds=[]; roundsResults=[]; roundsNumEl.textContent='0'; currentRoundEl.textContent='0';
  }

  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

  startBtn.onclick=()=>{
    if(currentListName==='trash' || (items[currentListName]||[]).length<2){alert('Нужно минимум два пункта');return;}
    if(running) return;
    prepareRounds(); curRound=curPair=0; running=true; startBtn.disabled=true;
    sortCard.style.display='block'; ratingDisplay.style.display='block'; bracketEl.style.display='block'; exitBtn.style.display='flex';
    runRounds();
  };

  exitBtn.onclick=()=>{if(confirm('Прервать сортировку?')){running=false;resetUI();exitBtn.style.display='none';startBtn.disabled=false;}};

  load();
  renderTabs();
  renderList();
  addBtn.style.display='none';
  itemInput.focus();
  exitBtn.style.display='none';
});
</script>
</body>
</html>